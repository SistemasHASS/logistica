<div class="card">
  <div class="card-header bg-white d-flex flex-column flex-md-row justify-content-between align-items-center">
    <div class="d-flex flex-wrap align-items-center mb-2 mb-md-0">
      <div class="list-icons d-flex flex-wrap mr-3 totalAncho">
        <label for="filtro">Filtro: </label>
        <input
          id="filtro"
          [(ngModel)]="filtro"
          (ngModelChange)="aplicarFiltro()"
          type="text"
          class="form-control mb-2 mb-sm-0"
        />
      </div>
    </div>
    <div class="d-flex flex-wrap align-items-center">
      <div class="list-icons d-flex flex-wrap mr-3 totalAncho">
        <label for="fdesde">Desde: </label>
        <input [(ngModel)]="fdesde" type="date" class="form-control mb-2 mb-sm-0" />
      </div>
      <div class="list-icons d-flex flex-wrap mr-3 totalAncho">
        <label for="fhasta">Hasta: </label>
        <input [(ngModel)]="fhasta" type="date" class="form-control mb-2 mb-sm-0" />
      </div>
      <button (click)="listarReporte()" class="btn totalAncho bg-primary" style="color: white;margin-top: 21px;">
        Listar <i class="icon icon-eye"></i>
      </button>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div *ngIf="dataFiltrada.length > 0" class="mb-2 mt-4 d-flex justify-content-end gap-2">
      <button class="btn btn-sm btn-success" (click)="exportarExcel()">
        <i class="icon icon-file-excel"></i> Excel
      </button>
    </div>

    <div class="row tablaEsconder" *ngIf="dataFiltrada.length > 0">
      <div class="col-md-12">
        <div class="table-responsive tabla-scroll">
          <p-table
            [value]="dataFiltrada"
            [paginator]="true"
            [rows]="20"
            [rowsPerPageOptions]="[10, 20, 50]"
            [totalRecords]="dataFiltrada.length"
            [pageLinks]="5"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="<{first} - {last} de {totalRecords}>"
            styleClass="p-datatable-sm tabla-compacta"
            responsiveLayout="scroll"
          >
            <ng-template pTemplate="header">
              <tr class="bg-primary text-white text-center">
                <th *ngFor="let col of columnas">
                  {{ getHeaderLabel(col) }}
                </th>
                <th style="min-width:100px">Detalles</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
              <tr>
                <td *ngFor="let col of columnas" class="text-center">
                  {{ getDisplayValue(col, row) }}
                </td>
                <td class="text-center">
                  <button class="btn btn-sm btn-info" (click)="verDetalles(row)">
                    <i class="icon icon-eye"></i>
                  </button>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td [attr.colspan]="columnas.length + 1" class="text-center">No hay registros</td>
              </tr>
            </ng-template>
          </p-table>
          <!-- Cards (vista responsive). Paginación independiente de la tabla -->
          @for (item of dataFiltradaPaginada; track $index) {
            <div class="card cardFor"
                [ngClass]="{ 'cerrado': item.estado, 'nocerrado': !item.estado }">

              <div class="contentCard">
                <div class="info" [ngClass]="{ 'eliminadoTR': item.eliminado }">

                  <p class="item-card">
                    <span
                      [ngClass]="{
                        'is-enviado': item.estados == 'APROBADO',
                        'is-noenviado': item.estados != 'APROBADO'
                      }">
                      [{{ item.estados == 'APROBADO' ? 'Enviado' : 'Sin enviar' }}]
                    </span>
                  </p>

                  <p class="item-card">
                    <strong>#Requerimiento:</strong>
                    {{ item.idrequerimiento }}
                  </p>

                  <p class="item-card">
                    <strong>#Requerimiento Spring:</strong>
                    {{ item.RequisicionNumero }}
                  </p>
                  
                  <p class="item-card">
                    <strong>Fecha:</strong>
                    {{ item.fecharegistro }}
                    - <strong>Almacén:</strong> {{ getNombreAlmacenCard(item, 'idalmacen') }}
                  </p>

                  <p class="item-card">
                    <strong>Glosa:</strong>
                    {{ getDisplayValue('glosa', item) }} - {{ getDisplayValue('tipo', item) }}
                  </p>

                </div>
              </div>
            </div>
          }

          <p-paginator
          class="paginator-responsive"
            *ngIf="dataFiltrada.length > 0"
            [first]="cardFirst"
            [rows]="cardRows"
            [totalRecords]="dataFiltrada.length"
            [rowsPerPageOptions]="[5, 10, 20, 50]"
            (onPageChange)="onCardPageChange($event)"
            styleClass="mt-2"
          ></p-paginator>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalles -->
<div class="modal-backdrop" *ngIf="modalDetallesAbierto">
  <div class="modal-content-detalles">
    <div class="modal-header-custom">
      <h4>Detalles del Requerimiento</h4>
      <button class="btn-close-custom" (click)="cerrarModalDetalles()">
        <i class="icon icon-x"></i>
      </button>
    </div>
    
    <div class="modal-body-custom" *ngIf="requerimientoSeleccionado">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="detalle-item">
            <label>ID Requerimiento:</label>
            <span>{{ requerimientoSeleccionado.idrequerimiento }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Requisición Número:</label>
            <span>{{ requerimientoSeleccionado.RequisicionNumero || 'N/A' }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Fecha Registro:</label>
            <span>{{ requerimientoSeleccionado.fecharegistro }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Estado:</label>
            <span class="badge" 
              [ngClass]="requerimientoSeleccionado.estados === 'APROBADO' ? 'bg-success' : 'bg-warning'">
              {{ requerimientoSeleccionado.estados || 'PENDIENTE' }}
            </span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Empresa:</label>
            <span>{{ getDisplayValue('ruc', requerimientoSeleccionado) }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Fundo:</label>
            <span>{{ getDisplayValue('idfundo', requerimientoSeleccionado) }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Almacén:</label>
            <span>{{ getDisplayValue('idalmacen', requerimientoSeleccionado) }}</span>
          </div>
        </div>
        
        <div class="col-md-6" *ngIf="requerimientoSeleccionado.idalmacendestino">
          <div class="detalle-item">
            <label>Almacén Destino:</label>
            <span>{{ getDisplayValue('idalmacendestino', requerimientoSeleccionado) }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Tipo:</label>
            <span>{{ requerimientoSeleccionado.tipo || 'N/A' }}</span>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="detalle-item">
            <label>Prioridad:</label>
            <span>{{ requerimientoSeleccionado.prioridad || 'N/A' }}</span>
          </div>
        </div>
        
        <div class="col-12">
          <div class="detalle-item">
            <label>Glosa:</label>
            <span>{{ requerimientoSeleccionado.glosa || 'Sin descripción' }}</span>
          </div>
        </div>
        
        <div class="col-md-6" *ngIf="requerimientoSeleccionado.idclasificacion">
          <div class="detalle-item">
            <label>Clasificación:</label>
            <span>{{ requerimientoSeleccionado.idclasificacion }}</span>
          </div>
        </div>
        
        <div class="col-md-6" *ngIf="requerimientoSeleccionado.idarea">
          <div class="detalle-item">
            <label>Área:</label>
            <span>{{ requerimientoSeleccionado.idarea }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer-custom">
      <button class="btn btn-secondary" (click)="cerrarModalDetalles()">
        Cerrar
      </button>
    </div>
  </div>
</div>