<div class="container-fluid">

  <h4 class="mb-3">LISTA DE REQUERIMIENTOS APROBADOS</h4>

  <table class="table table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Código</th>
        <th>Requerimiento</th>
        <th>Tipo</th>
        <th>Proyecto</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let r of requerimientosAprobados; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ r.idrequerimiento }}</td>
        <td>{{ r.glosa }}</td>
        <td>{{ r.tipo }}</td>
        <td>
          <div *ngFor="let d of r.detalle">
            {{ d.proyecto }}
          </div>
        </td>
        <td>{{ r.estados }}</td>
        <td>
          <button class="btn btn-primary btn-sm" (click)="verDetalle(r)">
            Atender
          </button>

          <button class="btn btn-success btn-sm ms-2"
            *ngIf="r.estado === 'ATENCION_PARCIAL' || r.estado === 'ATENCION_COMPLETA'" (click)="abrirDespachoFinal(r)">
            Despachar
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- =================== DETALLE ATENCIÓN =================== -->
  <div *ngIf="selected" class="mt-4">

    <h5>Detalle Requerimiento: {{ selected.idrequerimiento }}</h5>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Codigo</th>
          <th>{{ selected.tipo === 'ITEM' ? 'Producto' : 'Descripción' }}</th>
          <th>Solicitada</th>
          <th>Atendida</th>
          <th>Pendiente</th>
          <th>Atender</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of detalle">
          <th>{{ d.codigo }}</th>
          <!-- <td>{{ d.producto }}</td> -->
          <!-- ITEM -->
          <td *ngIf="selected.tipo === 'ITEM'">
            {{ d.producto }}
          </td>

          <!-- COMMODITY / ACTIVO FIJO / MENOR -->
          <td *ngIf="selected.tipo !== 'ITEM'">
            {{ d.descripcion }}
          </td>
          <td>{{ d.cantidad }}</td>
          <td>{{ d.atendida || 0 }}</td>
          <td>{{ d.cantidad - (d.atendida || 0) }}</td>
          <td>
            <input type="number" class="form-control" min="0" [max]="d.cantidad - (d.atendida || 0)"
              [(ngModel)]="d.atender" />
          </td>
        </tr>
      </tbody>
    </table>

    <button class="btn btn-warning" (click)="registrarAtencion()">
      Registrar Atención
    </button>

  </div>
</div>

<!-- ================= MODAL DESPACHO ================= -->
<div class="modal fade" id="modalDespacho" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Despacho Final - {{ selected?.codigo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th>Cantidad Atendida</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of detalleDespacho">
              <td>{{ d.producto }}</td>
              <td>{{ d.atendida }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" (click)="confirmarDespacho()">Confirmar Salida</button>
      </div>

    </div>
  </div>
</div>